machine:
  services:
    - docker
  hosts:
    neos-protobrew.local: 127.0.0.1

dependencies:
  pre:
    - docker info && docker version
    - docker pull million12/mariadb
    - docker pull million12/behat-selenium
    - docker pull million12/typo3-flow-neos-abstract

  override:
    - docker run -d --name=db --env="MARIADB_PASS=my-pass" million12/mariadb
    - docker logs -f db > ${CIRCLE_ARTIFACTS}/docker-db.log 2>&1:
        background: true

# Run tests
test:
  pre:
    - docker build --tag million12/neos-protobrew-distribution docker/
  
  override:
    # ######################################################
    # Run Neos CMS container, which includes
    # M12.Foundation / M12.FoundationSite packages
    # and do some basics checks.
    # ######################################################
    - docker run -d --name neos-protobrew -p 8080:80 --link db:db --env="T3APP_VHOST_NAMES=neos-protobrew" million12/neos-protobrew-distribution
    - docker logs -f neos-protobrew > ${CIRCLE_ARTIFACTS}/docker-neos-protobrew.log 2>&1:
        background: true
    - while true; do if grep "nginx entered RUNNING state" ${CIRCLE_ARTIFACTS}/docker-neos-protobrew.log; then break; else sleep 1; fi done
    
    # Test: do basic front-end tests 
    - curl -L --head http://neos-protobrew.local:8080 && curl -s -L http://neos-protobrew.local:8080
    - curl -s --head http://neos-protobrew.local:8080 | grep "HTTP/1.1 200 OK"
    - curl -s --head http://neos-protobrew.local:8080 | grep "X-Flow-Powered"
    - curl -s -L http://neos-protobrew.local:8080/neos | grep "Login to"
    
    # Run Neos tests (unit, functional), but do not fail the build in case of any problems there. These are vendor tests and errors there do not indicate that this Docker image is faulty.
    - |
      docker run -ti --volumes-from=neos-protobrew --link=neos-protobrew:web --link=db:db million12/behat-selenium "
        env && \
        echo \$WEB_PORT_80_TCP_ADDR \$WEB_ENV_T3APP_VHOST_NAMES >> /etc/hosts && cat /etc/hosts && \
        su www -c \"
          cd ~/typo3-app && \
          echo -e '\n\n======== RUNNING NEOS TESTS =======\n\n' && \
          bin/phpunit -c Build/BuildEssentials/PhpUnit/UnitTests.xml && \
          bin/phpunit -c Build/BuildEssentials/PhpUnit/FunctionalTests.xml
        \"
      " || true

deployment:
  rebuild_image_on_docker_hub:
    branch: /.*/
    commands:
      - 'curl -H "Content-Type: application/json" --data "{\"source_type\": \"Branch\", \"source_name\": \"$CIRCLE_BRANCH\"}" -X POST https://registry.hub.docker.com/u/million12/neos-protobrew-distribution/trigger/9a92812e-e721-4b63-bf6b-44e1f15a4b67/'
